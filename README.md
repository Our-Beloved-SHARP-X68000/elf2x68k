# elf2x68k

## 概要

PC環境のm68k用gccクロスツールチェインを用いてビルドされるELFファイルを、シャープ X680x0 用実行ファイル(X形式)に変換するpythonスクリプトです。

**本スクリプトは実験用です。** X68k用のクロス開発環境としては既に xdev68k (https://github.com/yosshin4004/xdev68k) が存在しますので、実用的な開発環境をお求めの方はこちらをご利用ください。

## 動作環境

動作はWindows11のWSL2にインストールしたUbuntu-20.04で確認しています。
事前に以下のように、m68k用gccクロスツールチェインをインストールしておく必要があります。
```
sudo apt install gcc-m68k-linux-gnu
```
スクリプト自体は特にOSには依存しないので、他のUnix/Linux系環境でも問題なく動作すると思います。

## 実行方法
```
usage: elf2x68k.py [-h] [-o OUTPUT] file1 [file2]
```

* file1, file2で指定したELFファイルを元にX形式に変換します。
* 変換後のファイルは　`-o` オプションが指定されていればそのファイル名で、オプションが省略されている場合は file1 に '.x' を追加したファイル名で作成されます。
* file1, file2はスタティックリンクされた、m68kアーキテクチャ用ELF実行ファイルである必要があります。
* file1のみが指定されている場合は、与えられたELFファイルをロード先アドレス固定X形式(Human.sysで使われている形式)に変換します。変換元のELFファイルのロード先アドレスがそのまま使われるので、X68kのディスクのブートセクタから起動可能なファイルを生成するためには、ELFファイルのリンク時にロード先アドレスを0x6800に指定しておく必要があります。
  * リンカのコマンドラインに `-Ttext=0x6800` を指定します
  * 詳細は src/hellosys/Makefile を参照
* file1, file2が指定されている場合は、2つのELFファイルの差分を利用することで再配置情報を生成し、変換後のX形式ファイルに付加します。これによりHuman68kから実行可能なファイルになります。正しく再配置情報を生成するためには、2つのファイルはロード先アドレス以外の内容がすべて等しいELFファイルである必要があります。
  * 詳細は src/hellox/Makefile を参照

## サンプル

elf2x68k を用いてX形式に変換できるサンプルコードを用意しています。

ソースコードはCで書かれていますが、m68k用GNUリンカで利用可能なX680x0用ライブラリが存在しないため、ライブラリ関数は標準Cライブラリに至るまで一切使用できません。
Cのスタートアップ処理も存在しないので、プログラムの先頭はmain()でなく_start()から始まります。

### src/hellosys

* ロード先アドレス固定のX形式ファイルを作成するサンプルです。
* makeすると hellosys.sys というバイナリが生成されます。このファイルは以下の手順で起動できます。
  1. 実機でフォーマット済みのフロッピーディスク、またはエミュレータでフォーマット済みディスクイメージを用意します
  2. hellosys.sys を **human.sys という名前で** ディスクにコピーします
      * ディスクには他のファイルを置かないでください。ブートセクタから起動できるファイルはディスクの連続したセクタに配置されている必要があるためです。
  3. 作成したディスク(イメージ)を実機またはエミュレータにセットし、リセットします。

### src/hellox

* 通常のX形式ファイルを生成するサンプルです。
* makeすると hellox.x というファイルができます。Human68kでそのまま実行できます。

## ライセンス

elf2x68k はBSDライセンスとします


